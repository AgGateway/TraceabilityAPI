title AgGateway Traceability - Planting Operations

actor Farmer
participant MobileApp
participant MobileLocalAPI
control Tractor Display
control CAN
control planter
control planter Box
participant arable field
database DataPlatform

== field selection; on-line ==
Farmer->MobileApp: retrieve my fields
MobileApp ->DataPlatform: GET /geospatial-list
DataPlatform -->MobileApp:geospatial-list
Farmer->MobileApp: select this field
MobileApp ->DataPlatform: GET /geospatial/{id}
DataPlatform -->MobileApp: geospatial

== shipped products; on-line ==
Farmer ->MobileApp: scan QR on delivery document
MobileApp ->DataPlatform: GET /shipped-item-instance-list?shipmentId
DataPlatform -->MobileApp: shipped-item-instance-list
MobileApp -> MobileApp: identify containers typeCode= bags | bulk box

loop until this field is complete
== fill operation, off-line MobileApp <-> MobileLocalAPI <-> SQLiteDB  ==
Farmer->MobileApp: Start Fill Operation
MobileApp -> MobileLocalAPI: POST /operation type=Fill
MobileApp ->Tractor Display: Wi-Fi: Start Fill Operation
note left of Tractor Display: future state with Wi-Fi/API-led displays
MobileApp -> MobileLocalAPI: GET /container-list
MobileLocalAPI --> MobileApp: container-list



loop for-each sourceContainer (Tender Bulk Box or Seed Bag)
Farmer ->MobileApp: identify source container
note left of MobileApp:RFID, Manifest QR
Farmer ->MobileApp: select product from list
note left of MobileApp: should match shipped Item Instance entry
MobileApp ->Tractor Display: Wi-Fi: select product from list

MobileApp -> MobileLocalAPI: POST /critical-tracking-event
note left of MobileLocalAPI: CTE type, tru.truRole=Source, \n tru.timePeriod.startDateTime, operation.UUID


MobileLocalAPI -->MobileApp: cteUUID, truUUID. truRoleUUID(Source)
loop for-each targetContainer (planter Box, fertilizer)
Farmer ->MobileApp: identify targetContainer
Farmer ->MobileApp:record start weight or volume pct
Farmer ->planter Box: fill targetContainer

MobileApp ->MobileLocalAPI: POST /traceable-resource-unit/{truUUID}/truRole
note left of MobileLocalAPI: roleCode=Target,timePeriod, 
MobileLocalAPI -->MobileApp:truRoleUUID(Target)
MobileApp -> MobileLocalAPI: PATCH /traceable-resource-unit/{truUUID(Source)}?endWeight=$
MobileLocalAPI -->MobileApp: truUUID(Source)


end
end
MobileApp ->MobileLocalAPI: PATCH /critical-tracking-event/{cteId}
note left of MobileLocalAPI: CTE transfer to planter status=complete with end date time
note left of MobileLocalAPI:CTE includes one TRU per target container with item instance (qty/lot)\nsourceTRU has remaining item volume weight

==operation planting; off-line MobileApp <-> MobileLocalAPI <-> SQLiteDB ==
MobileApp -> MobileLocalAPI: POST /operation type=Fill
MobileApp ->Tractor Display: Wi-Fi: Start Fill Operation
loop for-each sourceTRU with planterBox
MobileApp ->MobileLocalAPI: POST /traceable-resource-unit/{truUUID}?roleCode=source
note left of MobileLocalAPI: creates new truRole
end
Farmer -> MobileApp: start planting opertion
MobileApp -> MobileApp: Create Operation type=Plant
MobileApp ->Tractor Display: start planting operation
 note left of Tractor Display: future state with Wi-Fi/API-led displays
Tractor Display -> CAN: CAN message
CAN -> planter: I/O
planter -> planter: start vacuum motor
loop until-refill-required
planter ->planter Box: drop seed
planter Box ->arable field: drop seed
planter ->arable field: cover seed
planter -> planter: record point on arable field
planter ->Tractor Display: log point
end


Tractor Display --> MobileApp: geometry of subfield
DataPlatform ->DataPlatform: define subfield geometry for each sourceTRU
DataPlatform ->DataPlatform: geospatial intersection
DataPlatform ->DataPlatform: consolidate as appropriate
end
