title AgGateway Traceability - Planting Operations

actor Farmer
participant MobileApp
participant MobileLocalAPI
control Tractor Display
control CAN
control planter
control planter Box
participant arable field
database DataPlatform

== field selection ==
Farmer->MobileApp: retrieve my fields
MobileApp ->DataPlatform: GET /geospatial-list
DataPlatform -->MobileApp:geospatial-list
Farmer->MobileApp: select this field
MobileApp ->DataPlatform: GET /geospatial/{id}
DataPlatform -->MobileApp: geospatial

== shipped products ==
Farmer ->MobileApp: scan QR on delivery document
MobileApp ->DataPlatform: GET /shipped-item-instance-list?shipmentId
DataPlatform -->MobileApp: shipped-item-instance-list
MobileApp -> MobileApp: identify containers typeCode= bags | bulk box

== fill operation, off-line MobileApp <-> MobileLocalAPI <-> SQLiteDB  ==
Farmer->MobileApp: Start Fill Operation
MobileApp -> MobileLocalAPI: POST /operation type=Fill
MobileApp ->Tractor Display: Start Fill Operation
note right of Tractor Display: future state with Wi-Fi/API-led displays
MobileApp -> MobileLocalAPI: GET /container-list
MobileLocalAPI --> MobileApp: container-list
MobileAPP -> MobileLocalAPI: POST /critical-tracking-event
MobileLocalAPI -->MobileApp: cteUUID
note right of MobileLocalAPI: CTE type, tru.truRole=Source, \n tru.timePeriod.startDateTime, operation.UUID


loop for-each sourceContainer (Tender Bulk Box or Seed Bag)
Farmer ->MobileApp: identify source container
note right of MobileApp:RFID, Manifest QR
Farmer ->MobileApp: select product from list
note right of MobileApp: should match shipped Item Instance entry
MobileApp ->Tractor Display: Wi-Fi: select product from list
MobileApp -> MobileLocalAPI: POST /traceable-resource-unit typeCode=Source
MobileLocalAPI -->MobileApp: truUUID
loop for-each targetContainer (planter Box, fertilizer)
Farmer ->MobileApp: identify targetContainer
Farmer ->MobileApp:record start weight or volume pct
Farmer ->planter Box: fill targetContainer
opt
MobileApp ->MobileLocalAPI: POST /critical-tracking-event/{cteId}/traceable-resource-unit?roleCode=Target
MobileLocalAPI -->MobileApp:truRoleUUID, truUUID
MobileApp -> MobileLocalAPI: POST /critical-tracking-event/{cteId}/traceable-resource-unit/{sourceTRUId}?endWeight=$
MobileLocalAPI -->MobileApp: sourceTRUId
end
opt CTE for each sourceTRU to targetTRU level transfer
MobileApp ->MobileLocalAPI: POST /critical-tracking-event
note right of MobileLocalAPI:both sourceTRU and targetTRU captured
MobileLocalAPI -->MobileApp: cteId
end
end
end
MobileApp ->MobileLocalAPI: PATCH /critical-tracking-event/{cteId}
note right of MobileLocalAPI: CTE transfer to planter status=complete with end date time
note right of MobileLocalAPI:CTE includes one TRU per target container with item instance (qty/lot)\nsourceTRU has remaining item volume weight

== as-planted ==

loop for-each sourceTRU with planterBox
MobileApp ->MobileLocalAPI: POST /traceable-resource-unit/{truUUID}?roleCode=source
note right of MobileLocalAPI: creates new source roleCode fo
end
Farmer -> MobileApp: start planting opertion
MobileApp -> MobileApp: Create Operation type=Plant
MobileApp ->Tractor Display: start planting operation
 note right of Tractor Display: future state with Wi-Fi/API-led displays
Tractor Display -> CAN: CAN message
CAN -> planter: I/O
planter -> planter: start vacuum motor
loop until-refill-required
planter ->planter Box: drop seed
planter Box ->arable field: drop seed
planter ->arable field: cover seed
planter -> planter: record point on arable field
planter ->Tractor Display: log point
end


Tractor Display --> MobileApp: geometry of subfield
DataPlatform ->DataPlatform: define subfield geometry for each sourceTRU
DataPlatform ->DataPlatform: geospatial intersection
DataPlatform ->DataPlatform: consolidate as appropriate
